<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SpiceDB Test Interface</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>
  <body>
    <h1>SpiceDB Test Interface</h1>

    <!-- Section for Checking Permissions -->
    <section>
      <h2>Check Permission</h2>

      <form id="checkPermissionForm">
        <div>
          Example:
          <a
            href="#"
            class="example-data"
            data-values='{"q":"starship_system:enterprise_bridge#operate@user:picard"}'
            >starship_system:enterprise_bridge#operate@user:picard</a
          >
        </div>
        <input type="text" id="q" placeholder="Enter query" />
        <button type="button" id="checkButton">Check</button>
      </form>
      <p id="checkResult"></p>
    </section>

    <!-- Section for Listing Relationships -->
    <section>
      <h2>List Relationships</h2>
      <form id="listRelationshipsForm">
        <button type="button" id="listRelationshipsButton">
          List Relationships
        </button>
      </form>
      <ul id="relationshipsList"></ul>
    </section>

    <!-- Section for Lookup Subjects -->
    <section>
      <h2>Lookup Subjects</h2>

      <form id="lookupSubjectsForm">
        <div>
          Example:
          <a
            href="#"
            class="example-data"
            data-values='{"subjectObjectType":"user","permission":"operate","resource":"starship_system:enterprise_bridge"}'
            >user, operate, starship_system:enterprise_bridge</a
          >
        </div>
        <input
          type="text"
          id="subjectObjectType"
          placeholder="Subject Object Type"
        />
        <input type="text" id="permission" placeholder="Permission" />
        <input type="text" id="resource" placeholder="Resource" />
        <button type="button" id="lookupSubjectsButton">Lookup Subjects</button>
      </form>
      <pre id="lookupSubjectsResult"></pre>
    </section>

    <!-- Section for Lookup Resources -->
    <section>
      <h2>Lookup Resources</h2>

      <form id="lookupResourcesForm">
        <div>
          Example:
          <a
            href="#"
            class="example-data"
            data-values='{"resourceObjectType":"starship_system","permission":"operate","subject":"user:picard"}'
            >starship_system, operate, user:picard</a
          >
        </div>
        <input
          type="text"
          id="resourceObjectType"
          placeholder="Resource Object Type"
        />
        <input type="text" id="permission" placeholder="Permission" />
        <input type="text" id="subject" placeholder="Subject" />
        <button type="button" id="lookupResourcesButton">
          Lookup Resources
        </button>
      </form>
      <pre id="lookupResourcesResult"></pre>
    </section>

    <!-- Section for Expand Permission Tree -->
    <section>
      <h2>Expand Permission Tree</h2>

      <form id="expandPermissionTreeForm">
        <div>
          Example:
          <a
            href="#"
            class="example-data"
            data-values='{"resource":"starship_system:enterprise_bridge","permission":"operate"}'
            >starship_system:enterprise_bridge, operate</a
          >
        </div>
        <input type="text" id="resource" placeholder="Resource" />
        <input type="text" id="permission" placeholder="Permission" />
        <button type="button" id="expandPermissionTreeButton">
          Expand Tree
        </button>
      </form>
      <pre id="expandPermissionTreeResult"></pre>
    </section>

    <section>
      <h2>Expand Permission Tree (SVG/PNG)</h2>

      <form id="expandPermissionTreeImageForm">
        <div>
          Example:
          <a
            href="#"
            class="example-data"
            data-values='{"resource":"starship_system:enterprise_bridge","permission":"operate"}'
            >starship_system:enterprise_bridge, operate</a
          >
        </div>
        <input type="text" id="resource" placeholder="Resource" />
        <input type="text" id="permission" placeholder="Permission" />
        <select id="format">
          <option value="svg">SVG</option>
          <option value="png">PNG</option>
        </select>
        <button type="button" id="expandPermissionTreeImageButton">
          Expand Tree
        </button>
      </form>
      <div id="expandPermissionTreeImageResult"></div>
    </section>

    <script>
      // Generic function to send GET requests and update the result
      function handleButtonClick(buttonId, endpoint, resultElementId) {
        const button = document.getElementById(buttonId);
        button.addEventListener("click", (e) => {
          e.stopPropagation();
          e.preventDefault();
          const params = Array.from(button.form.elements)
            .filter((el) => el.tagName === "INPUT" || el.tagName === "SELECT")
            .reduce((acc, el) => {
              acc[el.id] = el.value;
              return acc;
            }, {});

          axios
            .get(`/${endpoint}?${new URLSearchParams(params).toString()}`, {
              responseType: "blob", // Always fetch as blob
            })
            .then((response) => {
              const contentType = response.headers["content-type"];
              const resultElement = document.getElementById(resultElementId);

              if (contentType && contentType.includes("image/png")) {
                // For binary responses (PNG)
                const url = URL.createObjectURL(response.data);
                resultElement.innerHTML = `<img src="${url}" alt="Permission Tree">`;
              } else {
                // For text responses (SVG or JSON)
                const reader = new FileReader();
                reader.onload = function (e) {
                  if (contentType && contentType.includes("application/json")) {
                    resultElement.innerText = JSON.stringify(
                      JSON.parse(e.target.result),
                      null,
                      2
                    );
                  } else {
                    resultElement.innerHTML = e.target.result;
                  }
                };
                reader.readAsText(response.data);
              }
            })
            .catch((error) => {
              document.getElementById(
                resultElementId
              ).innerText = `Error: ${error}`;
            });
        });
      }

      // Attach event handlers to buttons
      handleButtonClick("checkButton", "check", "checkResult");
      handleButtonClick(
        "listRelationshipsButton",
        "relationships",
        "relationshipsList"
      );
      handleButtonClick(
        "lookupSubjectsButton",
        "lookup-subjects",
        "lookupSubjectsResult"
      );
      handleButtonClick(
        "lookupResourcesButton",
        "lookup-resources",
        "lookupResourcesResult"
      );
      handleButtonClick(
        "expandPermissionTreeButton",
        "expand-permission-tree",
        "expandPermissionTreeResult"
      );
      handleButtonClick(
        "expandPermissionTreeImageButton",
        "expand-permission-tree-image",
        "expandPermissionTreeImageResult"
      );
      handleButtonClick(
        "starshipRelationshipsButton",
        "relationships/starship",
        "starshipRelationshipsList"
      );
      handleButtonClick(
        "starshipRoleRelationshipsButton",
        "relationships/starship_role",
        "starshipRoleRelationshipsList"
      );
      handleButtonClick(
        "starshipSystemRelationshipsButton",
        "relationships/starship_system",
        "starshipSystemRelationshipsList"
      );
      handleButtonClick(
        "userRelationshipsButton",
        "relationships/user",
        "userRelationshipsList"
      );

      // Function to fill input fields with provided data
      function fillFields(form, data) {
        Object.entries(data).forEach(([id, value]) => {
          form.querySelector(`#${id}`).value = value;
        });
      }

      function getParentForm(el) {
        let form;
        while (form === undefined) {
          form = el.parentElement;
          if (form.tagName !== "FORM") {
            form = form.parentElement;
          }
        }
        return form;
      }

      // Event listeners for example data
      document.querySelectorAll(".example-data").forEach((el) => {
        el.addEventListener("click", function (e) {
          e.stopPropagation();
          e.preventDefault();
          let form = getParentForm(this);
          const data = JSON.parse(this.getAttribute("data-values"));
          fillFields(form, data);
        });
      });
    </script>
  </body>
</html>
